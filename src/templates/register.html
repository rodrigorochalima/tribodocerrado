{% extends 'base.html' %}

{% block title %}Cadastro - Tribo do Cerrado{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <h3 class="mb-0"><i class="fas fa-user-plus me-2"></i>Cadastro de Novo Membro</h3>
                </div>
                <div class="card-body">
                    <!-- Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <form id="registerForm" method="POST" action="{{ url_for('auth.register') }}" class="needs-validation" novalidate>
                        <div class="row">
                            <!-- Informações Básicas -->
                            <div class="col-md-12 mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0"><i class="fas fa-id-card me-2"></i>Informações Básicas</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="username" class="form-label">Nome de Usuário*</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                                    <input type="text" class="form-control" id="username" name="username" required>
                                                </div>
                                                <div class="form-text">Escolha um nome de usuário único.</div>
                                                <div class="invalid-feedback">
                                                    Por favor, escolha um nome de usuário.
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="email" class="form-label">Email*</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                                    <input type="email" class="form-control" id="email" name="email" required>
                                                </div>
                                                <div class="form-text">Nunca compartilharemos seu email com terceiros.</div>
                                                <div class="invalid-feedback">
                                                    Por favor, forneça um email válido.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="full_name" class="form-label">Nome Completo*</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-signature"></i></span>
                                                    <input type="text" class="form-control" id="full_name" name="full_name" required>
                                                </div>
                                                <div class="invalid-feedback">
                                                    Por favor, forneça seu nome completo.
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="nickname" class="form-label">Apelido (opcional)</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                                    <input type="text" class="form-control" id="nickname" name="nickname">
                                                </div>
                                                <div class="form-text">Como você gostaria de ser chamado no clube.</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="birth_date" class="form-label">Data de Nascimento*</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-birthday-cake"></i></span>
                                                    <input type="date" class="form-control" id="birth_date" name="birth_date" required>
                                                </div>
                                                <div class="invalid-feedback">
                                                    Por favor, forneça sua data de nascimento.
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="blood_type" class="form-label">Tipo Sanguíneo (opcional)</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-tint"></i></span>
                                                    <select class="form-select" id="blood_type" name="blood_type">
                                                        <option value="">Selecione...</option>
                                                        <option value="A+">A+</option>
                                                        <option value="A-">A-</option>
                                                        <option value="B+">B+</option>
                                                        <option value="B-">B-</option>
                                                        <option value="AB+">AB+</option>
                                                        <option value="AB-">AB-</option>
                                                        <option value="O+">O+</option>
                                                        <option value="O-">O-</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Senha e Segurança -->
                            <div class="col-md-12 mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0"><i class="fas fa-lock me-2"></i>Senha e Segurança</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="password" class="form-label">Senha*</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-key"></i></span>
                                                    <input type="password" class="form-control" id="password" name="password" required>
                                                    <button class="btn btn-outline-secondary toggle-password" type="button" data-target="password">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                                <div class="password-strength mt-2 d-none" id="password-strength">
                                                    <div class="progress">
                                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                                    </div>
                                                    <ul class="list-unstyled small mt-2">
                                                        <li id="length"><i class="fas fa-times-circle text-danger"></i> Mínimo de 8 caracteres</li>
                                                        <li id="uppercase"><i class="fas fa-times-circle text-danger"></i> Pelo menos 1 letra maiúscula</li>
                                                        <li id="lowercase"><i class="fas fa-times-circle text-danger"></i> Pelo menos 1 letra minúscula</li>
                                                        <li id="number"><i class="fas fa-times-circle text-danger"></i> Pelo menos 1 número</li>
                                                        <li id="sequential"><i class="fas fa-times-circle text-danger"></i> Sem números sequenciais</li>
                                                        <li id="birthdate"><i class="fas fa-times-circle text-danger"></i> Não pode conter sua data de nascimento</li>
                                                    </ul>
                                                </div>
                                                <div class="invalid-feedback">
                                                    Por favor, crie uma senha forte.
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="confirm_password" class="form-label">Confirmar Senha*</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-key"></i></span>
                                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                                                    <button class="btn btn-outline-secondary toggle-password" type="button" data-target="confirm_password">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                                <div class="invalid-feedback">
                                                    As senhas não coincidem.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Termos e Condições -->
                            <div class="col-md-12 mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="terms" name="terms" required>
                                    <label class="form-check-label" for="terms">
                                        Eu li e concordo com os <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Termos e Condições</a> do Tribo do Cerrado
                                    </label>
                                    <div class="invalid-feedback">
                                        Você deve concordar com os termos para continuar.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Login Social -->
                            <div class="col-md-12 mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0"><i class="fas fa-share-alt me-2"></i>Ou cadastre-se com</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-center gap-3">
                                            <button type="button" class="btn btn-outline-primary" disabled>
                                                <i class="fab fa-facebook-f me-2"></i>Facebook
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" disabled>
                                                <i class="fab fa-google me-2"></i>Google
                                            </button>
                                            <button type="button" class="btn btn-outline-info" disabled>
                                                <i class="fab fa-instagram me-2"></i>Instagram
                                            </button>
                                        </div>
                                        <div class="text-center mt-2">
                                            <small class="text-muted">Em breve disponível</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-danger btn-lg">
                                        <i class="fas fa-user-plus me-2"></i> Cadastrar
                                    </button>
                                    <a href="{{ url_for('auth.login') }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-sign-in-alt me-2"></i> Já tenho uma conta
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Termos e Condições -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Termos e Condições</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>Termos de Uso do Tribo do Cerrado</h5>
                <p>Ao se cadastrar no site do Tribo do Cerrado, você concorda com os seguintes termos:</p>
                <ol>
                    <li>Todas as informações fornecidas são verdadeiras e precisas.</li>
                    <li>Você é responsável por manter a confidencialidade de sua senha.</li>
                    <li>O conteúdo publicado deve respeitar as normas do clube e a legislação brasileira.</li>
                    <li>O Tribo do Cerrado se reserva o direito de moderar conteúdo inadequado.</li>
                    <li>Suas informações pessoais serão tratadas conforme nossa política de privacidade.</li>
                </ol>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="acceptTerms">Aceitar</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts específicos para a página de registro -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validação do formulário
    const form = document.getElementById('registerForm');
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirm_password');
    const birthDate = document.getElementById('birth_date');
    const passwordStrength = document.getElementById('password-strength');
    
    // Mostrar indicador de força da senha
    password.addEventListener('focus', function() {
        passwordStrength.classList.remove('d-none');
    });
    
    // Validar força da senha em tempo real
    password.addEventListener('input', function() {
        validatePassword();
    });
    
    // Validar correspondência de senhas
    confirmPassword.addEventListener('input', function() {
        if (password.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('As senhas não coincidem');
        } else {
            confirmPassword.setCustomValidity('');
        }
    });
    
    // Aceitar termos pelo modal
    document.getElementById('acceptTerms').addEventListener('click', function() {
        document.getElementById('terms').checked = true;
    });
    
    // Toggle de visibilidade da senha
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const target = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (target.type === 'password') {
                target.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                target.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    });
    
    // Validação do formulário antes do envio
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        // Validar força da senha
        if (!validatePassword()) {
            event.preventDefault();
            alert('Por favor, crie uma senha forte que atenda a todos os requisitos.');
        }
        
        form.classList.add('was-validated');
    });
    
    // Função para validar a força da senha
    function validatePassword() {
        const value = password.value;
        const birthDateValue = birthDate.value ? new Date(birthDate.value) : null;
        
        // Critérios de validação
        const hasLength = value.length >= 8;
        const hasUpperCase = /[A-Z]/.test(value);
        const hasLowerCase = /[a-z]/.test(value);
        const hasNumber = /[0-9]/.test(value);
        const hasSequential = /123|234|345|456|567|678|789|987|876|765|654|543|432|321/.test(value);
        
        // Verificar se contém data de nascimento
        let hasBirthDate = false;
        if (birthDateValue) {
            const day = birthDateValue.getDate().toString().padStart(2, '0');
            const month = (birthDateValue.getMonth() + 1).toString().padStart(2, '0');
            const year = birthDateValue.getFullYear().toString();
            const shortYear = year.substring(2);
            
            // Verificar diferentes formatos de data
            hasBirthDate = value.includes(day + month) || 
                           value.includes(month + day) || 
                           value.includes(day + month + year) || 
                           value.includes(day + month + shortYear) ||
                           value.includes(year) ||
                           value.includes(shortYear);
        }
        
        // Atualizar indicadores visuais
        updateCriteriaStatus('length', hasLength);
        updateCriteriaStatus('uppercase', hasUpperCase);
        updateCriteriaStatus('lowercase', hasLowerCase);
        updateCriteriaStatus('number', hasNumber);
        updateCriteriaStatus('sequential', !hasSequential);
        updateCriteriaStatus('birthdate', !hasBirthDate);
        
        // Calcular força da senha (0-100)
        let strength = 0;
        if (hasLength) strength += 20;
        if (hasUpperCase) strength += 20;
        if (hasLowerCase) strength += 20;
        if (hasNumber) strength += 20;
        if (!hasSequential) strength += 10;
        if (!hasBirthDate) strength += 10;
        
        // Atualizar barra de progresso
        const progressBar = document.querySelector('#password-strength .progress-bar');
        progressBar.style.width = strength + '%';
        
        // Definir cor baseada na força
        if (strength < 40) {
            progressBar.className = 'progress-bar bg-danger';
        } else if (strength < 70) {
            progressBar.className = 'progress-bar bg-warning';
        } else {
            progressBar.className = 'progress-bar bg-success';
        }
        
        // Verificar se todos os critérios foram atendidos
        return hasLength && hasUpperCase && hasLowerCase && hasNumber && !hasSequential && !hasBirthDate;
    }
    
    // Atualizar status visual dos critérios
    function updateCriteriaStatus(id, isValid) {
        const element = document.getElementById(id);
        const icon = element.querySelector('i');
        
        if (isValid) {
            icon.className = 'fas fa-check-circle text-success';
        } else {
            icon.className = 'fas fa-times-circle text-danger';
        }
    }
});
</script>
{% endblock %}
